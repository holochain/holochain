on:
  push:
    branches:
      - "holochain.github.io"
  pull_request:
    branches:
      - "holochain.github.io"
  workflow_dispatch: {}

jobs:
  test_holonix_setup:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: x86_64-linux
          - os: macos-latest
            platform: aarch64-darwin
    runs-on: ${{ matrix.os }}
    steps:
      - name: Call setup script
        env:
          NIX_CONFIG: "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"
        run: |
          set -xe
          bash <(curl https://raw.githubusercontent.com/holochain/holochain/${{ github.sha }}/setup.sh)
      - name: Align Nix system features
        if: matrix.os == 'ubuntu-latest'
        run: |
          # GitHub's Ubuntu runners don't actually provide the extra features that
          # the multi-user installer adds (benchmark/kvm/uid-range/etc). Clearing the
          # list back to the default stops Nix rejecting builds during cache checks.
          sudo sed -i '/^system-features/d' /etc/nix/nix.conf
          echo 'system-features = x86_64-linux' | sudo tee -a /etc/nix/nix.conf
          sudo systemctl restart nix-daemon
      - name: Test nix command
        run: |
          set -x +e
          for file in \
              ~/.profile \
              /etc/profile \
              /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh \
              /nix/var/nix/profiles/default/etc/profile.d/nix.sh
          do
              source $file > /dev/null 2>&1
              if command -v nix; then break; fi
          done
          set -e
          # Persist the resolved PATH so later steps (like nix-cache-check) see the nix binary.
          echo "PATH=$PATH" >> "$GITHUB_ENV"
          nix run --version
      - name: Check Holonix cache
        uses: holochain/nix-cache-check@v1
        env:
          NIX_CONFIG: "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"
        with:
          derivation: github:holochain/holonix?ref=main-0.6#devShells.${{ matrix.platform }}.default
