name: "Test local cache"

on:
  pull_request:
    branches:
      - develop

jobs:
  # ensures the cache is regularly updated for the supported versions on multiple platforms
  cache-update:
    strategy:
      fail-fast: false
      matrix:
        extra_args:
          - '--override-input versions "./versions/0_1"'
        platform:
          - ubuntu-latest
          - macos-latest

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Print matrix
        env:
          MATRIX: ${{ toJSON(matrix) }}
        run: echo ${MATRIX}

      - uses: cachix/install-nix-action@v22

      - name: "Test cache ${{ matrix.extra_args }}"
        env:
          NIX_CONFIG: "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"
        run: |
          set -xe

          DOMAIN_SUFFIX_OVERRIDE=.cachix.org PUBLIC_KEY_OVERRIDE=holochain-ci.cachix.org-1:5IUSkZc0aoRS53rfkvH9Kid40NpyjwCMCzwRTXy+QN8= ./local-cache.sh use holochain-ci

          nix build -L -j0 \
            ${{ matrix.extra_args }} \
            .#holonix

          rm result*
