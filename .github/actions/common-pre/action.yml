name: 'Common Test Setup Actions'
runs:
  using: 'composite'
  steps:
    - name: free disk space
      if: matrix.os == 'ubuntu-latest'
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false

    - name: go toolchain
      uses: actions/setup-go@v5
      with:
        go-version: '=1.20.0'

    - name: install llvm & clang (ubuntu-latest)
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: sudo apt install -y build-essential cmake g++-multilib libgcc-11-dev lib32gcc-11-dev ccache

    - name: install llvm & clang (macos-latest & macos-13)
      if: matrix.os == 'macos-latest' || matrix.os == 'macos-13'
      shell: bash
      run: brew install cmake

    - name: install llvm & clang (windows-latest)
      if: matrix.os == 'windows-latest'
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "17"

    - name: install msvc (windows-latest)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1.4.1

    - name: rust cache
      uses: Swatinem/rust-cache@v2

    - name: cargo sweep stamp
      shell: bash
      run: |
        cargo install cargo-sweep
        cargo sweep --stamp

    - name: install vcpkg packages
      if: matrix.os == 'windows-latest'
      uses: johnwason/vcpkg-action@v6
      id: vcpkg
      with:
        triplet: x64-windows-release
        token: ${{ github.token }}
        manifest-dir: ${{ github.workspace }}/.github/manifest
        github-binarycache: true
