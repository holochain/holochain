environment:
  CACHIX_AUTH_TOKEN: ENCRYPTED[!51b70de0be9ef7f7dfe552db4a692f52d6d06f3dad0795084f0fe939f18cee9092ddd231038ae04353d21ea5c08b4add!]

# x86_64-linux_task:
#   container:
#     image: nixos/nix:latest
#   name: x86_64-linux
#   test_script: |
#     export NIX_CONFIG="extra-experimental-features = nix-command flakes impure-derivations ca-derivations"
#     nix run nixpkgs#cachix -- use holochain-ci
#     nix run nixpkgs#cachix -- watch-exec holochain-ci -- nix build -L .#holochain-tests-nextest

# aarch64-linux_task:
#   arm_container:
#     image: nixos/nix:latest
#   name: aarch64-linux
#   test_script: |
#     export NIX_CONFIG="extra-experimental-features = nix-command flakes impure-derivations ca-derivations"
#     nix run nixpkgs#cachix -- use holochain-ci
#     nix run nixpkgs#cachix -- watch-exec holochain-ci -- nix build -L .#holochain-tests-nextest

darwin_nix_task:
  name: Nix based tests on Darwin
  matrix:
    - SYSTEM: "x86_64-darwin"
    - SYSTEM: "aarch64-darwin"

  macos_instance:
    image: ghcr.io/cirruslabs/macos-ventura-base:latest

  test_script: |
    sh <(curl -L https://nixos.org/nix/install)
    source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh > /dev/null 2>&1
    source /nix/var/nix/profiles/default/etc/profile.d/nix.sh > /dev/null 2>&1
    echo "trusted-users = root $USER" | sudo tee -a /etc/nix/nix.conf
    sudo launchctl kickstart -k system/org.nixos.nix-daemon

    export NIX_CONFIG="extra-experimental-features = nix-command flakes impure-derivations ca-derivations"
    nix run nixpkgs#cachix -- use -m user-nixconf holochain-ci
    nix run nixpkgs#cachix -- watch-exec holochain-ci -- nix build -L .#holochain-tests-nextest --system ${SYTEM}
